---
title: "Assignment 3 - Linear models for Cirrhosis dataset"
author: "Sergi Mayol y Toni Garri"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries

```{r}
library(GGally)
library(ggplot2)
library(dplyr)
library(gridExtra)
library(ggcorrplot)
```

## Data

```{r}
dataset <- read.csv("../datasets/cirrhosis.csv")
```

## Data preparation
```{r}
summary(dataset)
```

```{r}
str(dataset)
```

```{r}
df <- dataset
```

```{r}
df <- subset(df, select = -ID)
```

```{r}
df <- df %>% mutate(Drug = ifelse(is.na(Drug), "None", Drug))
```

```{r}
ggplot(df, aes(x = Drug)) +
  geom_bar(fill = "skyblue", color = "black", alpha = 0.7) +
  labs(title = "Drugs taken", x = "Drug", y = "Count")
```
```{r}
ggplot(df, aes(x = Status)) +
  geom_bar(fill = "skyblue", color = "black", alpha = 0.7) +
  labs(title = "Status", x = "Status", y = "Count")
```

```{r}
df$AgeInYear <- df$Age / 365.25 # 366
df$AgeInYear
```

```{r}
df$grupo_edad <- cut(df$AgeInYear,
  breaks = seq(0, 100, by = 10),
  include.lowest = TRUE,
  labels = FALSE
)
df$grupo_edad
```
```{r}
ggplot(df, aes(x = grupo_edad)) +
  geom_bar(fill = "skyblue", color = "black", alpha = 0.7) +
  labs(title = "Number of people per decade", x = "Decade group", y = "Count")
```

```{r}
plot_corr <- ggcorr(
  data = df,
  low = "steelblue",
  mid = "white",
  high = "darkred",
  label = TRUE,
  label_alpha = 0,
  angle = -45,
  max_size = 10,
  min_size = 2,
  size = 3,
  hjust = 0.75
)
plot_corr +
  theme(text = element_text(size = 8))
```

```{r}
stage_proportions <- round(prop.table(table(df$Stage)), 2)
pie(stage_proportions, labels = paste(names(stage_proportions), ": ", stage_proportions), col = rainbow(length(stage_proportions)))
legend("topright", legend = names(stage_proportions), fill = rainbow(length(stage_proportions)), cex = 0.8, title = "Stage")
```

```{r}
stage_df <- subset(df, select = c(Stage, Ascites, Hepatomegaly, Spiders, Cholesterol, Alk_Phos, Bilirubin, Albumin, Copper, SGOT, Tryglicerides, Platelets, Prothrombin))

summary(stage_df)

stage_df <- stage_df %>% mutate(Ascites = ifelse(is.na(Ascites), "None", Ascites))
stage_df <- stage_df %>% mutate(Hepatomegaly = ifelse(is.na(Hepatomegaly), "None", Hepatomegaly))
stage_df <- stage_df %>% mutate(Spiders = ifelse(is.na(Spiders), "None", Spiders))
stage_df <- stage_df %>% mutate(Cholesterol = ifelse(is.na(Cholesterol), mean(Cholesterol, na.rm = TRUE), Cholesterol))
stage_df <- stage_df %>% mutate(Alk_Phos = ifelse(is.na(Alk_Phos), mean(Alk_Phos, na.rm = TRUE), Alk_Phos))
stage_df <- stage_df %>% mutate(SGOT = ifelse(is.na(SGOT), mean(SGOT, na.rm = TRUE), SGOT))
stage_df <- stage_df %>% mutate(Copper = ifelse(is.na(Copper), mean(Copper, na.rm = TRUE), Copper))
stage_df <- stage_df %>% mutate(Tryglicerides = ifelse(is.na(Tryglicerides), mean(Tryglicerides, na.rm = TRUE), Tryglicerides))
stage_df <- stage_df %>% mutate(Platelets = ifelse(is.na(Platelets), mean(Platelets, na.rm = TRUE), Platelets))
stage_df <- stage_df %>% mutate(Prothrombin = ifelse(is.na(Prothrombin), mean(Prothrombin, na.rm = TRUE), Prothrombin))
stage_df <- stage_df %>% mutate(Stage = ifelse(is.na(Stage), median(Stage, na.rm = TRUE), Stage))
```

```{r}
summary(stage_df)
str(stage_df)
```

```{r}
ggplot(stage_df, aes(x = Stage)) +
  geom_bar(fill = "skyblue", color = "black", alpha = 0.7)
```

```{r}
plot_corr <- ggcorr(
  data = stage_df,
  low = "steelblue",
  mid = "white",
  high = "darkred",
  label = TRUE,
  label_alpha = 0,
  angle = -45,
  max_size = 10,
  min_size = 2,
  size = 3,
  hjust = 0.75
)
plot_corr +
  theme(text = element_text(size = 8))
```

## Models

### Data split

```{r}
labels <- as.numeric(as.factor(df$Status))
labels

set.seed(123)
index <- sample(1:nrow(stage_df), 0.7 * nrow(stage_df))

train_data <- stage_df[index, ]
train_labels <- as.matrix(labels[index])

test_data <- stage_df[-index, ]
test_labels <- as.matrix(labels[-index])

nrow(train_data)
nrow(train_labels)
nrow(test_data)
nrow(test_labels)
```

Modelos a emplear:

- Perceptron / lm <-
- Random dec. tree <-
- nearest neighbours <-
- SVM <-
- Logistic re

Objetivos:
- survival state of patients with liver cirrhosis

```{r}
library(mlpack)
library(caret)
```

### Perceptron

```{r}
perceptron_ <- perceptron(training = train_data, labels = train_labels)

perceptron_model <- perceptron_$output_model
```

```{r}
precep_output <- perceptron(input_model = perceptron_model, test = test_data)
percep_pred <- precep_output$predictions
```

```{r}
percep_res <- confusionMatrix(factor(percep_pred, levels = c(1, 2, 3)), factor(test_labels))
percep_res
```

### Random Forest

```{r}
random_forest_ <- random_forest(training = train_data, labels = train_labels)

randft_model <- random_forest_$output_model
```

```{r}
randft_output <- random_forest(input_model = randft_model, test = test_data)
randft_pred <- randft_output$predictions
```

```{r}
randft_res <- confusionMatrix(factor(randft_pred, levels = c(1, 2, 3)), factor(test_labels))
randft_res
```

### Linear SVM

```{r}
svm_ <- linear_svm(training = train_data, labels = train_labels)

svm_model <- svm_$output_model
```

```{r}
svm_output <- linear_svm(input_model = svm_model, test = test_data)
svm_pred <- svm_output$predictions
```

```{r}
svm_res <- confusionMatrix(factor(svm_pred, levels = c(1, 2, 3)), factor(test_labels))
svm_res
```

## Softmax Regression

```{r}
soft_ <- softmax_regression(training = train_data, labels = train_labels)
soft_model <- soft_$output_model
```

```{r}
soft_output <- softmax_regression(input_model = soft_model, test = test_data)
soft_pred <- soft_output$predictions
```

```{r}
soft_res <- confusionMatrix(factor(soft_pred, levels = c(1, 2, 3)), factor(test_labels))
soft_res
```
## Naive Bayes Classifier

```{r}
nbc_ <- nbc(training = train_data, labels = train_labels)

nbc_model <- nbc_$output_model
```

```{r}
nbc_output <- nbc(input_model = nbc_model, test = test_data)
nbc_pred <- nbc_output$predictions
```

```{r}
nbc_res <- confusionMatrix(factor(nbc_pred, levels = c(1, 2, 3)), factor(test_labels))
nbc_res
```

## Decision Tree

```{r}
dec_tree_ <- decision_tree(training = train_data, labels = train_labels)

dec_tree_model <- dec_tree_$output_model
```

```{r}
output <- decision_tree(input_model = dec_tree_model, test = test_data)
dec_tree_pred <- output$predictions
```

```{r}
dec_tree_res <- confusionMatrix(factor(dec_tree_pred, levels = c(1, 2, 3)), factor(test_labels))
dec_tree_res
```

## Adaptive Boosting

```{r}
adaboost_ <- adaboost(training = train_data, labels = train_labels)
adaboost_model <- adaboost_$output_model
```

```{r}
output <- adaboost(input_model = adaboost_model, test = test_data)
adaboost_pred <- output$predictions
```

```{r}
adaboost_res <- confusionMatrix(factor(adaboost_pred, levels = c(1, 2, 3)), factor(test_labels))
adaboost_res
``` 

```{r}
confmat_plot <- function(confusion_df, ttl) {
  plot <- ggplot(confusion_df, aes(x = Reference, y = Prediction)) +
    geom_tile(aes(fill = Freq), color = "white") +
    geom_text(aes(label = Freq), vjust = 1) +
    scale_fill_gradient(low = "red", high = "blue") +
    theme_minimal() +
    labs(
      title = ttl,
      x = "Label",
      y = "Prediction"
    )
  plot
}

grid.arrange(
  confmat_plot(data.frame(percep_res$table), "Perceptron"),
  confmat_plot(data.frame(randft_res$table), "Random Forest"),
  confmat_plot(data.frame(svm_res$table), "SVM"),
  confmat_plot(data.frame(soft_res$table), "Softmax"),
  confmat_plot(data.frame(nbc_res$table), "Naive Bayes"),
  confmat_plot(data.frame(dec_tree_res$table), "Decision Tree"),
  confmat_plot(data.frame(adaboost_res$table), "Adaptive Boost."),
  ncol = 3
)
```

```{r}

```
