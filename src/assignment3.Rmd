---
title: "Assignment 3 - Linear models for Cirrhosis dataset"
author: "Sergi Mayol y Toni Garri"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries

```{r}
library(GGally)
library(ggplot2)
library(dplyr)
library(gridExtra)
library(ggcorrplot)
```

## Data

```{r}
dataset <- read.csv("../datasets/cirrhosis.csv")
```

## Data preparation
```{r}
summary(dataset)
```

```{r}
str(dataset)
```

```{r}
df <- dataset
```

```{r}
df <- subset(df, select = -ID)
```

```{r}
df <- df %>% mutate(Drug = ifelse(is.na(Drug), "None", Drug))
```

```{r}
ggplot(df, aes(x = Drug)) +
  geom_bar(fill = "skyblue", color = "black", alpha = 0.7) +
  labs(title = "Drugs taken", x = "Drug", y = "Count")
```
```{r}
ggplot(df, aes(x = Status)) +
  geom_bar(fill = "skyblue", color = "black", alpha = 0.7) +
  labs(title = "Status", x = "Status", y = "Count")
```

```{r}
df$AgeInYear <- df$Age / 365.25 # 366
df$AgeInYear
```

```{r}
df$grupo_edad <- cut(df$AgeInYear,
  breaks = seq(0, 100, by = 10),
  include.lowest = TRUE,
  labels = FALSE
)
df$grupo_edad
```
```{r}
ggplot(df, aes(x = grupo_edad)) +
  geom_bar(fill = "skyblue", color = "black", alpha = 0.7) +
  labs(title = "Number of people per decade", x = "Decade group", y = "Count")
```

```{r}
plot_corr <- ggcorr(
  data = df,
  low = "steelblue",
  mid = "white",
  high = "darkred",
  label = TRUE,
  label_alpha = 0,
  angle = -45,
  max_size = 10,
  min_size = 2,
  size = 3,
  hjust = 0.75
)
plot_corr +
  theme(text = element_text(size = 8))
```

```{r}
stage_proportions <- round(prop.table(table(df$Stage)), 2)
pie(stage_proportions, labels = paste(names(stage_proportions), ": ", stage_proportions), col = rainbow(length(stage_proportions)))
legend("topright", legend = names(stage_proportions), fill = rainbow(length(stage_proportions)), cex = 0.8, title = "Stage")
```

```{r}
stage_df <- subset(df, select = c(Stage, Ascites, Hepatomegaly, Spiders, Cholesterol, Alk_Phos, Bilirubin, Albumin, Copper, SGOT, Tryglicerides, Platelets, Prothrombin))

summary(stage_df)

stage_df <- stage_df %>% mutate(Ascites = ifelse(is.na(Ascites), "None", Ascites))
stage_df <- stage_df %>% mutate(Hepatomegaly = ifelse(is.na(Hepatomegaly), "None", Hepatomegaly))
stage_df <- stage_df %>% mutate(Spiders = ifelse(is.na(Spiders), "None", Spiders))
stage_df <- stage_df %>% mutate(Cholesterol = ifelse(is.na(Cholesterol), mean(Cholesterol, na.rm = TRUE), Cholesterol))
stage_df <- stage_df %>% mutate(Alk_Phos = ifelse(is.na(Alk_Phos), mean(Alk_Phos, na.rm = TRUE), Alk_Phos))
stage_df <- stage_df %>% mutate(SGOT = ifelse(is.na(SGOT), mean(SGOT, na.rm = TRUE), SGOT))
stage_df <- stage_df %>% mutate(Copper = ifelse(is.na(Copper), mean(Copper, na.rm = TRUE), Copper))
stage_df <- stage_df %>% mutate(Tryglicerides = ifelse(is.na(Tryglicerides), mean(Tryglicerides, na.rm = TRUE), Tryglicerides))
stage_df <- stage_df %>% mutate(Platelets = ifelse(is.na(Platelets), mean(Platelets, na.rm = TRUE), Platelets))
stage_df <- stage_df %>% mutate(Prothrombin = ifelse(is.na(Prothrombin), mean(Prothrombin, na.rm = TRUE), Prothrombin))
stage_df <- stage_df %>% mutate(Stage = ifelse(is.na(Stage), median(Stage, na.rm = TRUE), Stage))
```

```{r}
summary(stage_df)
str(stage_df)
```

```{r}
ggplot(stage_df, aes(x = Stage)) +
  geom_bar(fill = "skyblue", color = "black", alpha = 0.7)
```

```{r}
plot_corr <- ggcorr(
  data = stage_df,
  low = "steelblue",
  mid = "white",
  high = "darkred",
  label = TRUE,
  label_alpha = 0,
  angle = -45,
  max_size = 10,
  min_size = 2,
  size = 3,
  hjust = 0.75
)
plot_corr +
  theme(text = element_text(size = 8))
```

## Models

### Data split

```{r}
labels <- as.numeric(as.factor(df$Status))
labels

set.seed(123)
index <- sample(1:nrow(stage_df), 0.7 * nrow(stage_df))

train_data <- stage_df[index, ]
train_labels <- as.matrix(labels[index])

test_data <- stage_df[-index, ]
test_labels <- as.matrix(labels[-index])

nrow(train_data)
nrow(train_labels)
nrow(test_data)
nrow(test_labels)
```

Modelos a emplear:

- Perceptron / lm <-
- Random dec. tree <-
- nearest neighbours <-
- SVM <-
- Logistic re

Objetivos:
- survival state of patients with liver cirrhosis

```{r}
library(mlpack)
library(caret)
```

```{r}
train_test_split <- function(x_df, y_labs, test_size, seed) {
  set.seed(seed)
  index <- sample(1:nrow(x_df), (1 - test_size) * nrow(x_df))

  train_data <- x_df[index, ]
  train_labels <- as.matrix(y_labs[index])

  test_data <- x_df[-index, ]
  test_labels <- as.matrix(y_labs[-index])

  return(list(
    train_data = train_data,
    train_labels = train_labels,
    test_data = test_data,
    test_labels = test_labels
  ))
}
```
 
```{r}
run_classifier <- function(classifier, train_data, train_labels, test_data, test_labels) {
  model <- classifier(training = train_data, labels = train_labels)
  model <- model$output_model

  output <- classifier(input_model = model, test = test_data)
  predictions <- output$predictions

  res <- confusionMatrix(
    factor(predictions, levels = c(1, 2, 3)),
    factor(test_labels)
  )

  return(res)
}
```

### Perceptron

```{r}
percep_runs <- list(list(1234, stage_df), list(4567, stage_df), list(2805, stage_df))

percep_results <- vector("list", length = length(percep_runs))

for (i in seq_along(percep_runs)) {
  s_ <- percep_runs[[i]][[1]]
  x_ <- percep_runs[[i]][[2]]

  res <- train_test_split(x_df = x_, y_labs = labels, test_size = 0.2, seed = s_)

  model_res <- run_classifier(
    perceptron,
    res$train_data,
    res$train_labels,
    res$test_data,
    res$test_labels
  )

  percep_results[[i]] <- model_res
}

percep_results
```

### Random Forest
```{r}
randft_runs <- list(list(1234, stage_df), list(4567, stage_df), list(2805, stage_df))

randft_results <- vector("list", length = length(randft_runs))

for (i in seq_along(randft_runs)) {
  s_ <- randft_runs[[i]][[1]]
  x_ <- randft_runs[[i]][[2]]

  res <- train_test_split(x_df = x_, y_labs = labels, test_size = 0.2, seed = s_)

  model_res <- run_classifier(
    random_forest,
    res$train_data,
    res$train_labels,
    res$test_data,
    res$test_labels
  )

  randft_results[[i]] <- model_res
}

randft_results
```

### Linear SVM
```{r}
svm_runs <- list(list(1234, stage_df), list(4567, stage_df), list(2805, stage_df))

svm_results <- vector("list", length = length(svm_runs))

for (i in seq_along(svm_runs)) {
  s_ <- svm_runs[[i]][[1]]
  x_ <- svm_runs[[i]][[2]]

  res <- train_test_split(x_df = x_, y_labs = labels, test_size = 0.2, seed = s_)

  model_res <- run_classifier(
    linear_svm,
    res$train_data,
    res$train_labels,
    res$test_data,
    res$test_labels
  )

  svm_results[[i]] <- model_res
}

svm_results
```

## Softmax Regression

```{r}
soft_runs <- list(list(1234, stage_df), list(4567, stage_df), list(2805, stage_df))

soft_results <- vector("list", length = length(soft_runs))

for (i in seq_along(soft_runs)) {
  s_ <- soft_runs[[i]][[1]]
  x_ <- soft_runs[[i]][[2]]

  res <- train_test_split(x_df = x_, y_labs = labels, test_size = 0.2, seed = s_)

  model_res <- run_classifier(
    softmax_regression,
    res$train_data,
    res$train_labels,
    res$test_data,
    res$test_labels
  )

  soft_results[[i]] <- model_res
}

soft_results
```

## Naive Bayes Classifier
```{r}
nbc_runs <- list(list(1234, stage_df), list(4567, stage_df), list(2805, stage_df))

nbc_results <- vector("list", length = length(nbc_runs))

for (i in seq_along(nbc_runs)) {
  s_ <- nbc_runs[[i]][[1]]
  x_ <- nbc_runs[[i]][[2]]

  res <- train_test_split(x_df = x_, y_labs = labels, test_size = 0.2, seed = s_)

  model_res <- run_classifier(
    nbc,
    res$train_data,
    res$train_labels,
    res$test_data,
    res$test_labels
  )

  nbc_results[[i]] <- model_res
}

nbc_results
```

## Decision Tree

```{r}
dec_tree_runs <- list(list(1234, stage_df), list(4567, stage_df), list(2805, stage_df))

dec_tree_results <- vector("list", length = length(dec_tree_runs))

for (i in seq_along(dec_tree_runs)) {
  s_ <- dec_tree_runs[[i]][[1]]
  x_ <- dec_tree_runs[[i]][[2]]

  res <- train_test_split(x_df = x_, y_labs = labels, test_size = 0.2, seed = s_)

  model_res <- run_classifier(
    decision_tree,
    res$train_data,
    res$train_labels,
    res$test_data,
    res$test_labels
  )

  dec_tree_results[[i]] <- model_res
}

dec_tree_results
```

## Adaptive Boosting

```{r}
adaboost_runs <- list(list(1234, stage_df), list(4567, stage_df), list(2805, stage_df))

adaboost_results <- vector("list", length = length(adaboost_runs))

for (i in seq_along(adaboost_runs)) {
  s_ <- adaboost_runs[[i]][[1]]
  x_ <- adaboost_runs[[i]][[2]]

  res <- train_test_split(x_df = x_, y_labs = labels, test_size = 0.2, seed = s_)

  model_res <- run_classifier(
    adaboost,
    res$train_data,
    res$train_labels,
    res$test_data,
    res$test_labels
  )

  adaboost_results[[i]] <- model_res
}

adaboost_results
```

## Results 

```{r}
confmat_plot <- function(confusion_df, ttl) {
  plot <- ggplot(confusion_df, aes(x = Reference, y = Prediction)) +
    geom_tile(aes(fill = Freq), color = "white") +
    geom_text(aes(label = Freq), vjust = 1) +
    scale_fill_gradient(low = "red", high = "blue") +
    theme_minimal() +
    labs(
      title = ttl,
      x = "Label",
      y = "Prediction"
    )
  plot
}

grid.arrange(
  confmat_plot(data.frame(percep_results[[1]]$table), "Perceptron"),
  confmat_plot(data.frame(randft_results[[1]]$table), "Random Forest"),
  confmat_plot(data.frame(svm_results[[1]]$table), "SVM"),
  confmat_plot(data.frame(soft_results[[1]]$table), "Softmax"),
  confmat_plot(data.frame(nbc_results[[1]]$table), "Naive Bayes"),
  confmat_plot(data.frame(dec_tree_results[[1]]$table), "Decision Tree"),
  confmat_plot(data.frame(adaboost_results[[1]]$table), "Adaptive Boost."),
  ncol = 3
)
```

```{r}
models_results <- list(
  percep_results, randft_results, svm_results,
  soft_results, nbc_results, dec_tree_results, adaboost_results
)

accurracies <- vector("list", length = length(models_results))
idx_1 <- 1
for (model_results in models_results) {
  model_accurracy <- vector("list", length = length(model_results))
  idx_2 <- 1
  for (result in model_results) {
    model_accurracy[[idx_2]] <- result$overall[1]
    idx_2 <- idx_2 + 1
  }
  accurracies[[idx_1]] <- model_accurracy
  idx_1 <- idx_1 + 1
}

accuracy_model1 <- unlist(accurracies[[1]])
accuracy_model2 <- unlist(accurracies[[2]])
accuracy_model3 <- unlist(accurracies[[3]])
accuracy_model4 <- unlist(accurracies[[4]])
accuracy_model5 <- unlist(accurracies[[5]])
accuracy_model6 <- unlist(accurracies[[6]])
accuracy_model7 <- unlist(accurracies[[7]])

accuracy_df <- data.frame(
  Model = rep(c("Perceptron", "Random Forest", "SVM", "Softmax", "Naive Bayes", "Decision Tree", "AdaBoost"), each = length(accuracy_model1)),
  Accuracy = c(accuracy_model1, accuracy_model2, accuracy_model3, accuracy_model4, accuracy_model5, accuracy_model6, accuracy_model7)
)

ggplot(accuracy_df, aes(x = Model, y = Accuracy, fill = Model)) +
  geom_boxplot() +
  labs(title = "Grouped Boxplot of Accuracy", y = "Accuracy") +
  theme_minimal()
```
